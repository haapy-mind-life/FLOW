<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>FLOW â€” Simple Timer (Android Fix)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no">
  <meta name="theme-color" content="#2F5D34">
  <style>
    :root{
      --flow-bg-start:#E6F5E9; --flow-bg-mid:#A3D9A5; --flow-bg-end:#E6F5E9;
      --flow-fg:#2F5D34; --flow-accent:#34784A; --flow-ring:#5F8F6A;
      --tap:56px; --fs-base: clamp(16px, 2.5vw, 18px); --fs-xl: clamp(22px, 4vw, 28px);
    }
    *{box-sizing:border-box} html,body{height:100%}
    body{
      min-height:100dvh; margin:0;
      background: linear-gradient(180deg, var(--flow-bg-start), var(--flow-bg-mid) 60%, var(--flow-bg-end));
      color: var(--flow-fg);
      font: 400 var(--fs-base)/1.5 system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      -webkit-text-size-adjust:100%;
      overflow:auto; display:grid; place-items:center;
      padding:max(env(safe-area-inset-top),12px) 12px max(env(safe-area-inset-bottom),12px);
    }
    .card{ width:min(480px, 92vw); background:rgba(255,255,255,.6); border-radius:20px; box-shadow:0 10px 24px rgba(0,0,0,.12); padding:16px; text-align:center; }
    .title{ font-weight:700; margin:4px 0 8px; opacity:.9 }
    .ring-wrap{ display:grid; place-items:center; margin:6px 0 10px }
    .time{ margin-top:8px; font-size:var(--fs-xl); font-weight:800; letter-spacing:.5px }
    .ring{ filter:drop-shadow(0 6px 18px rgba(0,0,0,.08)) }
    .ring-bg{ stroke:#ffffff66; stroke-width:10; fill:none }
    .ring-fg{ stroke:var(--flow-ring); stroke-width:10; fill:none; stroke-linecap:round; transform:rotate(-90deg); transform-origin:60px 60px;
      stroke-dasharray:339.292; stroke-dashoffset:0; transition:stroke-dashoffset .2s linear; }
    .presets{ display:grid; grid-template-columns:repeat(3,1fr); gap:10px; margin-top:10px }
    .preset{ display:grid; place-items:center; min-height:var(--tap); border-radius:14px; background:#fff; box-shadow:0 6px 16px rgba(0,0,0,.08); cursor:pointer; user-select:none; font-size:22px }
    .preset span{ display:block; line-height:1 }
    .hint{ margin-top:8px; font-size:.9rem; opacity:.8 }
    .row{ display:flex; align-items:center; justify-content:center; gap:10px; margin-top:8px; }
    .toggle{ appearance: none; width: 44px; height: 26px; border-radius: 40px; background:#cfd8cf; position:relative; outline:none; cursor:pointer; }
    .toggle::after{ content:''; position:absolute; top:3px; left:3px; width:20px; height:20px; background:#fff; border-radius:20px; box-shadow:0 1px 3px rgba(0,0,0,.2); transition:.2s; }
    .toggle:checked{ background:#68b46f; }
    .toggle:checked::after{ left:21px; }

    .stop{ margin-top:10px; width:100%; min-height:calc(var(--tap) - 6px); border:0; border-radius:14px; background:#d94a4a; color:#fff; font-weight:700; cursor:pointer; box-shadow:0 10px 20px rgba(217,74,74,.22); display:none }
    .stop.show{ display:block }
    .brand{ margin-top:8px; opacity:.7; font-size:.85rem }

    /* ì˜¤ë””ì˜¤ ì–¸ë½ ì˜¤ë²„ë ˆì´ */
    .unlock{
      position:fixed; inset:0; display:grid; place-items:center;
      background:linear-gradient(180deg, rgba(230,245,233,.95), rgba(163,217,165,.85));
      z-index:9999;
    }
    .unlock .box{
      width:min(420px, 90vw); background:#fff; border-radius:16px; padding:16px; box-shadow:0 10px 24px rgba(0,0,0,.16); text-align:center;
    }
    .unlock .btn{
      margin-top:10px; width:100%; min-height:var(--tap); border:0; border-radius:14px; background:#34784A; color:#fff; font-weight:800; cursor:pointer;
      box-shadow:0 10px 20px rgba(52,120,74,.25);
    }
    .status{ margin-top:8px; font-size:.9rem; opacity:.8 }
  </style>
</head>
<body>
  <!-- ì˜¤ë””ì˜¤ ì–¸ë½ ì˜¤ë²„ë ˆì´ -->
  <div id="unlock" class="unlock" role="dialog" aria-modal="true" aria-label="ì˜¤ë””ì˜¤ í™œì„±í™”">
    <div class="box">
      <div style="font-weight:800;font-size:1.1rem;">ì†Œë¦¬ í™œì„±í™” í•„ìš”</div>
      <div class="status">ê°¤ëŸ­ì‹œ S25+ì—ì„œ ì•ŒëŒì„ ìœ„í•´ í•œ ë²ˆ ëˆŒëŸ¬ì£¼ì„¸ìš”.</div>
      <button id="unlock-btn" class="btn">íƒ­í•´ì„œ ì†Œë¦¬ í™œì„±í™”</button>
    </div>
  </div>

  <main class="card" role="main" aria-label="FLOW ë‹¨ìˆœ íƒ€ì´ë¨¸">
    <div class="title">FLOW Â· ì§‘ì¤‘/íœ´ì‹ íƒ€ì´ë¨¸</div>

    <section class="ring-wrap" aria-live="polite">
      <svg id="progress-ring" class="ring" width="220" height="220" viewBox="0 0 120 120" role="img" aria-label="ë‚¨ì€ ì‹œê°„">
        <circle class="ring-bg" cx="60" cy="60" r="54"></circle>
        <circle id="ring-circle" class="ring-fg" cx="60" cy="60" r="54"></circle>
      </svg>
      <div id="time-remaining" class="time">00:00</div>
    </section>

    <section class="presets" aria-label="í”„ë¦¬ì…‹">
      <div class="preset" data-sec="300"  title="5ë¶„ ì‹œì‘"><span>ğŸŒ±</span></div>
      <div class="preset" data-sec="900"  title="15ë¶„ ì‹œì‘"><span>ğŸŒ³</span></div>
      <div class="preset" data-sec="1800" title="30ë¶„ ì‹œì‘"><span>ğŸŒ²</span></div>
    </section>

    <div class="row" title="í™”ë©´ êº¼ì§ ë°©ì§€ (ì„ íƒ)">
      <label style="display:flex;align-items:center;gap:8px;cursor:pointer;">
        <input id="keep-awake" type="checkbox" class="toggle" />
        <span>í™”ë©´êº¼ì§ ë°©ì§€</span>
      </label>
    </div>

    <button id="stop-btn" class="stop" aria-pressed="false">ì •ì§€</button>
    <div class="hint">ì´ëª¨ì§€ë¥¼ íƒ­í•˜ë©´ ì‹œì‘ Â· ì§„í–‰ ì¤‘ì—” ì•„ë˜ <b>ì •ì§€</b></div>
    <div class="brand">Â© 2024â€“2025 FLOW</div>
  </main>

  <!-- HTMLAudio ë°±ì—…ìš© ì§§ì€ ì•ŒëŒ(ë‚´ì¥ WAV) -->
  <audio id="beep" preload="auto"
    src="data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAESsAACJWAAACABYAAAABAAACAAAASAAAAAE/////AAAAAP//AAD///8AAAAAAP///wAAAAAA">
  </audio>

  <script>
    /* ===== ì „ì—­ ìƒíƒœ ===== */
    let isRunning=false, intervalId=null, total=0, remain=0;
    const CIRCUM = 2 * Math.PI * 54;
    const ring = document.getElementById('ring-circle');
    const timeLabel = document.getElementById('time-remaining');
    const stopBtn = document.getElementById('stop-btn');

    /* ===== ì˜¤ë””ì˜¤ ì–¸ë½(ê°¤ëŸ­ì‹œ ê°•í™”) ===== */
    let audioCtx=null, unlocked=false;
    const unlockEl = document.getElementById('unlock');
    const unlockBtn = document.getElementById('unlock-btn');
    const beepEl = document.getElementById('beep');

    async function doUnlock() {
      try{
        if(!audioCtx) audioCtx = new (window.AudioContext||window.webkitAudioContext)();
        await audioCtx.resume?.();

        // ë¬´ìŒ + ê°€ì²­ í…ŒìŠ¤íŠ¸ìŒ(ì•„ì£¼ ì‘ê²Œ) ì¬ìƒ
        const now = audioCtx.currentTime;
        const o = audioCtx.createOscillator();
        const g = audioCtx.createGain();
        o.type='sine'; o.frequency.value=880;
        g.gain.setValueAtTime(0.0001, now);
        g.gain.exponentialRampToValueAtTime(0.03, now+0.02);
        g.gain.exponentialRampToValueAtTime(0.0001, now+0.08);
        o.connect(g); g.connect(audioCtx.destination);
        o.start(now); o.stop(now+0.09);

        // HTMLAudioë„ í•œ ë²ˆ ì‹œë„ (ë°±ì—… ê²½ë¡œ)
        try{ await beepEl.play(); beepEl.pause(); beepEl.currentTime=0; }catch(_){}

        unlocked = true;
        unlockEl.style.display = 'none';
      }catch(e){
        document.querySelector('.status').textContent = 'í™œì„±í™”ë¥¼ ë‹¤ì‹œ ëˆŒëŸ¬ì£¼ì„¸ìš” (ë³¼ë¥¨/ë¬´ìŒëª¨ë“œ í™•ì¸)';
      }
    }
    // ì²« í™”ë©´ì—ì„œ ëª…ì‹œì ìœ¼ë¡œ íƒ­
    unlockBtn.addEventListener('click', doUnlock);

    // ì¶”ê°€ ë³´ê°•: ë‹¤ë¥¸ ì œìŠ¤ì²˜ì—ì„œë„ ì–¸ë½ ì‹œë„
    ['touchstart','mousedown','keydown'].forEach(evt=>{
      window.addEventListener(evt, ()=>{ if(!unlocked) doUnlock(); }, {passive:true});
    });

    // ë°±ê·¸ë¼ìš´ë“œ ë³µê·€ ì‹œ ì¬ê°œ
    document.addEventListener('visibilitychange', ()=>{
      if(document.visibilityState==='visible' && audioCtx){
        audioCtx.resume?.();
      }
    });

    function ensureAudio() {
      if(!unlocked) return doUnlock();
      return audioCtx?.resume?.();
    }

    /* ===== í™”ë©´êº¼ì§ ë°©ì§€(ì„ íƒ) ===== */
    let wakeLock = null;
    async function requestWakeLock(){
      try{ wakeLock = await navigator.wakeLock.request('screen'); }
      catch(e){ /* ì¼ë¶€ ê¸°ê¸°/ì„¤ì •ì—ì„œ ë¯¸ì§€ì› */ }
    }
    function releaseWakeLock(){ try{ wakeLock?.release(); wakeLock=null; }catch(e){} }
    document.getElementById('keep-awake').addEventListener('change', (e)=>{
      if(e.target.checked) requestWakeLock(); else releaseWakeLock();
    });
    // íƒ­ ì „í™˜/ë³µê·€ ì‹œ ì¬ìš”ì²­
    document.addEventListener('visibilitychange', ()=>{
      if(document.visibilityState==='visible' && document.getElementById('keep-awake').checked){ requestWakeLock(); }
    });

    /* ===== ìœ í‹¸ ===== */
    function fmt(sec){ const m=Math.floor(sec/60), s=sec%60; return `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`; }
    function setProgress(fr){ ring.style.strokeDashoffset = String(CIRCUM * (1 - fr)); }
    function vib(ms=20){ try{ navigator.vibrate && navigator.vibrate(ms); }catch(e){} }

    // WebAudio ì¢…ì†Œë¦¬ + HTMLAudio ë™ì‹œ ì¬ìƒ
    async function chime(){
      await ensureAudio();
      try{
        const now = audioCtx.currentTime;
        const seq = [
          { t:0.00, f:880, d:0.18, v:0.18 },
          { t:0.22, f:659, d:0.22, v:0.16 }
        ];
        seq.forEach(step=>{
          const o=audioCtx.createOscillator(), g=audioCtx.createGain();
          o.type='sine'; o.frequency.value=step.f;
          g.gain.setValueAtTime(0, now+step.t);
          g.gain.linearRampToValueAtTime(step.v, now+step.t+0.02);
          g.gain.exponentialRampToValueAtTime(0.0001, now+step.t+step.d);
          o.connect(g); g.connect(audioCtx.destination);
          o.start(now+step.t); o.stop(now+step.t+step.d+0.03);
        });
      }catch(e){}
      try{ beepEl.currentTime=0; await beepEl.play(); }catch(e){}
      vib(30);
    }

    /* ===== íƒ€ì´ë¨¸ ===== */
    let intervalId2=null;
    function start(duration){
      if(isRunning) return;
      ensureAudio(); // ì‹œì‘ ì‹œ ë³´ì¥
      isRunning = true; total = duration; remain = duration;
      timeLabel.textContent = fmt(remain); setProgress(1);
      stopBtn.classList.add('show'); stopBtn.setAttribute('aria-pressed','true');

      clearInterval(intervalId); clearInterval(intervalId2);
      intervalId = setInterval(()=>{
        remain = Math.max(0, remain - 1);
        timeLabel.textContent = fmt(remain);
        setProgress(total ? remain/total : 0);
        if(remain<=0){
          clearInterval(intervalId); intervalId=null; isRunning=false;
          stopBtn.classList.remove('show'); stopBtn.setAttribute('aria-pressed','false');
          chime(); // ì¢…ë£Œ ì•ŒëŒ
        }
      }, 1000);

      // ë³´ìˆ˜ì : 4ì´ˆë§ˆë‹¤ resume ì¬ì‹œë„(ì¼ë¶€ ì ˆì „ëª¨ë“œ ëŒ€ì‘)
      intervalId2 = setInterval(()=>{ if(audioCtx) audioCtx.resume?.(); }, 4000);
    }
    function stopTimer(){
      if(!isRunning) return;
      clearInterval(intervalId); intervalId=null; isRunning=false;
      clearInterval(intervalId2); intervalId2=null;
      stopBtn.classList.remove('show'); stopBtn.setAttribute('aria-pressed','false');
      vib(15);
    }

    // í”„ë¦¬ì…‹ ì´ëª¨ì§€ í´ë¦­ â†’ ì¦‰ì‹œ ì‹œì‘
    document.querySelectorAll('.preset').forEach(el=>{
      el.addEventListener('click', ()=>{
        const sec = parseInt(el.getAttribute('data-sec'), 10) || 300;
        start(sec);
      }, {passive:true});
    });

    // ì •ì§€ ë²„íŠ¼
    stopBtn.addEventListener('click', stopTimer);

    // ì´ˆê¸° ìƒíƒœ
    timeLabel.textContent = "00:00";
    setProgress(0);
  </script>
</body>
</html>
